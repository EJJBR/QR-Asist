{% extends "base.html" %}

{% block title %}Leer QR - QR-Asist{% endblock %}

{% block header %}Lector de CÃ³digos QR - Registro de Asistencias{% endblock %}

{% block content %}
<div class="lector-section">
    
    <!-- SecciÃ³n principal: CÃ¡mara + Feedback -->
    <div class="camara-container">
        
        <div class="camara-wrapper">
            <div id="camaraBox" class="camara-box">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <div id="camaraEstado" class="camara-estado">
                    <p>ğŸ¥ Iniciando cÃ¡mara...</p>
                </div>
            </div>
        </div>
        
        <div class="feedback-panel">
            <div id="feedbackVacio" class="feedback-vacio">
                <p class="icon-large">ğŸ‘‹</p>
                <p>Esperando escaneo...</p>
                <p class="help-text">Coloca el cÃ³digo QR frente a la cÃ¡mara</p>
            </div>
            
            <div id="feedbackExito" class="feedback-card feedback-exito" style="display: none;">
                <div class="feedback-header">
                    <span class="icon">âœ…</span>
                    <h3>ENTRADA REGISTRADA</h3>
                </div>
                <div class="feedback-body">
                    <p class="feedback-hora">ğŸ• <span id="feedbackHora">--:--:--</span></p>
                    <p class="feedback-fecha">ğŸ“… <span id="feedbackFecha">--/--/----</span></p>
                    <p class="feedback-alumno">ğŸ‘¤ <span id="feedbackNombre">---</span></p>
                    <p class="feedback-seccion">ğŸ“š <span id="feedbackSeccion">---</span></p>
                </div>
            </div>
            
            <div id="feedbackDuplicado" class="feedback-card feedback-duplicado" style="display: none;">
                <div class="feedback-header">
                    <span class="icon">âš ï¸</span>
                    <h3>YA REGISTRADO</h3>
                </div>
                <div class="feedback-body">
                    <p class="feedback-mensaje" id="feedbackMensajeDup">---</p>
                    <p class="feedback-alumno">ğŸ‘¤ <span id="feedbackNombreDup">---</span></p>
                    <p class="feedback-seccion">ğŸ“š <span id="feedbackSeccionDup">---</span></p>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- EstadÃ­sticas del dÃ­a -->
    <div class="card">
        <h3>ğŸ“Š EstadÃ­sticas de hoy</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <p class="stat-label">Total registrados:</p>
                <p class="stat-value" id="totalHoy">0</p>
            </div>
            <div class="stat-item">
                <p class="stat-label">Laptop:</p>
                <p class="stat-value" id="laptopId">---</p>
            </div>
        </div>
    </div>
    
    <!-- Ãšltimos registros -->
    <div class="card">
        <h3>ğŸ“ Ãšltimos 5 registros</h3>
        <div id="ultimosRegistros" class="ultimos-registros">
            <p class="empty-state">No hay registros aÃºn</p>
        </div>
    </div>
    
    <!-- Estado de red y envÃ­o -->
    <div class="card">
        <h3>ğŸ“¡ Estado de conexiÃ³n</h3>
        <div class="red-status">
            <p id="redEstado" class="red-desconectado">
                <span class="icon">âŒ</span>
                <span>Sin conexiÃ³n de red</span>
            </p>
            <p id="redInfo" class="help-text">Verificando...</p>
        </div>
        
        <div class="actions-grid">
            <button id="btnEnviarArchivos" class="btn btn-primary" disabled>
                <span class="icon">ğŸ“¤</span>
                Enviar registros
            </button>
            
            <button id="btnDetener" class="btn btn-danger">
                <span class="icon">ğŸ”´</span>
                Detener lectura
            </button>
        </div>
    </div>
    
</div>

<!-- Modal: Enviar Archivos -->
<div id="modalEnviar" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ“¤ Enviar registros a PC Central</h3>
            <button class="modal-close" onclick="cerrarModalEnviar()">&times;</button>
        </div>
        
        <div class="modal-body">
            <p class="help-text">Selecciona los archivos que deseas enviar:</p>
            
            <div id="listaArchivosEnviar" class="archivos-lista">
                <p class="empty-state">Cargando archivos...</p>
            </div>
            
            <div class="modal-actions">
                <button id="btnSeleccionarTodos" class="btn btn-secondary btn-small">
                    â˜‘ Seleccionar todos
                </button>
                <button id="btnDeseleccionarTodos" class="btn btn-secondary btn-small">
                    â˜ Deseleccionar todos
                </button>
            </div>
            
            <div class="destino-info">
                <p class="help-text">
                    <strong>ğŸ“ Destino:</strong> 
                    <span id="rutaDestino">---</span>
                </p>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="cerrarModalEnviar()">
                âŒ Cancelar
            </button>
            <button id="btnConfirmarEnvio" class="btn btn-success">
                <span class="icon">ğŸ“¤</span>
                Enviar seleccionados (<span id="contadorSeleccionados">0</span>)
            </button>
        </div>
    </div>
</div>

<!-- Modal: Resultado de EnvÃ­o -->
<div id="modalResultado" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="resultadoTitulo">âœ… EnvÃ­o completado</h3>
        </div>
        
        <div class="modal-body">
            <div id="resultadoContenido">
                <!-- Se llenarÃ¡ dinÃ¡micamente -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="cerrarModalResultado()">
                âœ“ Cerrar
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/leer_qr.js') }}"></script>
{% endblock %}